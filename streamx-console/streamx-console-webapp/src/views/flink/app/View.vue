<template>
  <div>
    <a-row :gutter="24">
      <a-col class="gutter-row" :span="6">
        <a-skeleton class="gutter-box" :loading="dashLoading" active/>
        <div class="gutter-box" v-if="!dashLoading">
          <a-card :bordered="false" class="dash-statistic">
            <a-statistic
              title="Available Task Slots"
              :value="metrics.availableSlot"
              :value-style="{color: '#3f8600', fontSize: '45px', fontWeight: 500, textShadow: '1px 1px 0 rgba(0,0,0,0.2)'}">
            </a-statistic>
          </a-card>
          <a-divider style="margin-bottom: 10px"/>
          <div>
            <span>
              Total Task Slots
              <strong>{{ metrics.totalSlot }}</strong>
            </span>
            <a-divider type="vertical"/>
            <span>
              Task Managers
              <strong>{{ metrics.totalTM }}</strong>
            </span>
          </div>
        </div>
      </a-col>
      <a-col class="gutter-row" :span="6">
        <a-skeleton class="gutter-box" :loading="dashLoading" active/>
        <div class="gutter-box" v-if="!dashLoading">
          <a-card :bordered="false" class="dash-statistic">
            <a-statistic
              title="Running Jobs"
              :value="metrics.runningJob"
              :value-style="{color: '#3f8600', fontSize: '45px', fontWeight: 500, textShadow: '1px 1px 0 rgba(0,0,0,0.2)'}">
            </a-statistic>
          </a-card>
          <a-divider style="margin-bottom: 10px"/>
          <div>
            <span>
              Total Task
              <strong>{{ metrics.task.total }}</strong>
            </span>
            <a-divider type="vertical"/>
            <span>
              Running Task
              <strong>{{ metrics.task.running }}</strong>
            </span>
          </div>
        </div>
      </a-col>
      <a-col class="gutter-row" :span="6">
        <a-skeleton class="gutter-box" :loading="dashLoading" active/>
        <div class="gutter-box" v-if="!dashLoading">
          <a-card :bordered="false" class="dash-statistic">
            <a-statistic
              title="JobManager Memory"
              :value="metrics.jmMemory"
              :precision="0"
              suffix="MB"
              :value-style="{color: '#3f8600', fontSize: '45px', fontWeight: 500, textShadow: '1px 1px 0 rgba(0,0,0,0.2)'}">
            </a-statistic>
          </a-card>
          <a-divider style="margin-bottom: 10px"/>
          <div>
            <span>
              Total TaskManager Mem
              <strong>{{ metrics.jmMemory }} MB</strong>
            </span>
          </div>
        </div>
      </a-col>
      <a-col class="gutter-row" :span="6">
        <a-skeleton class="gutter-box" :loading="dashLoading" active/>
        <div class="gutter-box" v-if="!dashLoading">
          <a-card :bordered="false" class="dash-statistic">
            <a-statistic
              title="TaskManager Memory"
              :value="metrics.tmMemory"
              :precision="0"
              suffix="MB"
              :value-style="{color: '#3f8600', fontSize: '45px', fontWeight: 500, textShadow: '1px 1px 0 rgba(0,0,0,0.2)'}">
            </a-statistic>
          </a-card>
          <a-divider style="margin-bottom: 10px"/>
          <div>
            <span>
              Total TaskManager Mem
              <strong>{{ metrics.tmMemory }} MB</strong>
            </span>
          </div>
        </div>
      </a-col>
    </a-row>

    <a-card :bordered="false" style="margin-top: 20px">

      <!-- 表格区域 -->
      <a-table
        ref="TableInfo"
        :columns="columns"
        :expandIcon="handleExpandIcon"
        size="middle"
        rowKey="id"
        class="app_list"
        style="margin-top: -24px"
        :dataSource="dataSource"
        :pagination="pagination"
        :loading="loading"
        :scroll="{ x: 700 }"
        @change="handleTableChange">

        <a-table
          slot="expandedRowRender"
          class="expanded-table"
          slot-scope="record"
          v-if="record.state === 5"
          rowKey="id"
          :columns="innerColumns"
          :data-source="record.expanded"
          :pagination="false">
        </a-table>

        <div
          slot="filterDropdown"
          slot-scope="{ setSelectedKeys, selectedKeys, confirm, clearFilters, column }"
          style="padding: 8px">
          <a-input
            v-ant-ref="c => (searchInput = c)"
            :placeholder="`Search ${column.title}`"
            :value="selectedKeys[0]"
            style="width: 220px; margin-bottom: 8px; display: block;"
            @change="e => setSelectedKeys(e.target.value ? [e.target.value] : [])"
            @pressEnter="() => handleSearch(selectedKeys, confirm, column.dataIndex)"/>
          <a-button
            type="primary"
            icon="search"
            size="small"
            style="width: 90px; margin-right: 8px"
            @click="() => handleSearch(selectedKeys, confirm, column.dataIndex)">
            Search
          </a-button>
          <a-button size="small" style="width: 90px" @click="() => handleReset(clearFilters)">
            Reset
          </a-button>
        </div>

        <a-icon
          slot="filterIcon"
          slot-scope="filtered"
          type="search"
          :style="{ color: filtered ? '#108ee9' : undefined }"/>

        <template slot="filterRender" slot-scope="text, record, index, column">
          <!--有条件搜索-->
          <template v-if="searchText && searchedColumn === column.dataIndex">
            <span
              v-if="column.dataIndex === 'jobName'"
              :class="{pointer: record.state === 4 || record.state === 5 || record.optionState === 4 }"
              @click="handleView(record)">
              <!--start: record.deploy === 0-->
              <template
                v-if="record.deploy === 0"
                v-for="(fragment, i) in text.trim().substr(0,25).toString().split(new RegExp(`(?<=${searchText})|(?=${searchText})`, 'i'))">
                <mark v-if="fragment.toLowerCase() === searchText.toLowerCase()" :key="i" class="highlight">
                  {{ fragment }}
                </mark>
                <template v-else>
                  {{ fragment }}
                </template>
              </template>
              <!--end: record.deploy === 0-->
              <!--start: record.deploy === 1-->
              <a-badge v-if="record.deploy === 1" dot title="应用已更新,需重新发布">
                <template v-if="text.length>25">
                  <a-tooltip placement="top">
                    <template slot="title">
                      {{ text }}
                    </template>
                    <template
                      v-for="(fragment, i) in text.substr(0,25).toString().split(new RegExp(`(?<=${searchText})|(?=${searchText})`, 'i'))">
                      <mark v-if="fragment.toLowerCase() === searchText.toLowerCase()" :key="i" class="highlight">
                        {{ fragment }}
                      </mark>
                      <template v-else>
                        {{ fragment }}
                      </template>
                    </template>
                    ...
                  </a-tooltip>
                </template>
                <template v-else>
                  <template
                    v-for="(fragment, i) in text.trim().toString().split(new RegExp(`(?<=${searchText})|(?=${searchText})`, 'i'))">
                    <mark v-if="fragment.toLowerCase() === searchText.toLowerCase()" :key="i" class="highlight">
                      {{ fragment }}
                    </mark>
                    <template v-else>
                      {{ fragment }}
                    </template>
                  </template>
                </template>
              </a-badge>
              <!-- end: record.deploy === 1-->
              <!--start: record.deploy === 2-->
              <a-badge dot color="blue" v-if="record.deploy === 2" title="配置已更新,需重启应用">
                <template v-if="text.length>25">
                  <a-tooltip placement="top">
                    <template slot="title">
                      {{ text }}
                    </template>
                    <template
                      v-for="(fragment, i) in text.trim().substr(0,25).toString().split(new RegExp(`(?<=${searchText})|(?=${searchText})`, 'i'))">
                      <mark v-if="fragment.toLowerCase() === searchText.toLowerCase()" :key="i" class="highlight">
                        {{ fragment }}
                      </mark>
                      <template v-else>
                        {{ fragment }}
                      </template>
                    </template>
                    ...
                  </a-tooltip>
                </template>
                <template v-else>
                  <template
                    v-for="(fragment, i) in text.trim().toString().split(new RegExp(`(?<=${searchText})|(?=${searchText})`, 'i'))">
                    <mark v-if="fragment.toLowerCase() === searchText.toLowerCase()" :key="i" class="highlight">
                      {{ fragment }}
                    </mark>
                    <template v-else>
                      {{ fragment }}
                    </template>
                  </template>
                </template>
              </a-badge>
              <!-- end: record.deploy === 2-->
              <!-- start: record.deploy === 3-->
              <a-badge dot color="blue" v-if="record.deploy === 3" title="程序已发布完成,需重启应用">
                <template v-if="text.length>25">
                  <a-tooltip placement="top">
                    <template slot="title">
                      {{ text }}
                    </template>
                    <template
                      v-for="(fragment, i) in text.trim().substr(0,25).toString().split(new RegExp(`(?<=${searchText})|(?=${searchText})`, 'i'))">
                      <mark v-if="fragment.toLowerCase() === searchText.toLowerCase()" :key="i" class="highlight">
                        {{ fragment }}
                      </mark>
                      <template v-else>
                        {{ fragment }}
                      </template>
                    </template>
                    ...
                  </a-tooltip>
                </template>
                <template v-else>
                  <template
                    v-for="(fragment, i) in text.trim().toString().split(new RegExp(`(?<=${searchText})|(?=${searchText})`, 'i'))">
                    <mark v-if="fragment.toLowerCase() === searchText.toLowerCase()" :key="i" class="highlight">
                      {{ fragment }}
                    </mark>
                    <template v-else>
                      {{ fragment }}
                    </template>
                  </template>
                </template>
              </a-badge>
              <!-- end: record.deploy === 3-->
              <a-badge
                class="close-deploy"
                @click.stop="handleCleanDeploy(record)"
                v-if="record.deploy !== 0"
                v-permit="'app:clean'">
                <a-icon slot="count" type="close" style="color: #333"/>
              </a-badge>
            </span>
            <!--其他字段-->
            <span v-else>
              <template
                v-for="(fragment, i) in text.trim().substr(0,25).toString().split(new RegExp(`(?<=${searchText})|(?=${searchText})`, 'i'))">
                <mark v-if="fragment.toLowerCase() === searchText.toLowerCase()" :key="i" class="highlight">
                  {{ fragment }}
                </mark>
                <template v-else>
                  {{ fragment }}
                </template>
              </template>
            </span>
          </template>
          <!--无条件搜索-->
          <template v-else>
            <span
              v-if="column.dataIndex === 'jobName'"
              :class="{pointer: record.state === 4 || record.state === 5 || record.optionState === 4 }"
              @click="handleView(record)">
              <a-badge dot title="应用已更新,需重新发布" v-if="record.deploy === 1">
                <ellipsis :length="45" tooltip>
                  {{ text }}
                </ellipsis>
              </a-badge>
              <a-badge dot color="blue" title="配置已更新,需重启应用" v-else-if="record.deploy === 2">
                <ellipsis :length="45" tooltip>
                  {{ text }}
                </ellipsis>
              </a-badge>
              <a-badge dot color="blue" title="程序已发布完成,需重启应用" v-else-if="record.deploy === 3">
                <ellipsis :length="45" tooltip>
                  {{ text }}
                </ellipsis>
              </a-badge>
              <span v-else>
                <ellipsis :length="45" tooltip>
                  {{ text }}
                </ellipsis>
              </span>
              <a-badge
                class="close-deploy"
                @click.stop="handleCleanDeploy(record)"
                v-if="record.deploy !== 0"
                v-permit="'app:clean'">
                <a-icon slot="count" type="close" style="color: #333"/>
              </a-badge>
            </span>
            <span v-else>
              <ellipsis :length="45" tooltip>
                {{ text }}
              </ellipsis>
            </span>
          </template>
        </template>

        <template slot="duration" slot-scope="text, record">
          {{ record.duration | duration }}
        </template>

        <template slot="task" slot-scope="text, record">
          <State option="task" :data="record"></State>
        </template>

        <template slot="state" slot-scope="text, record">
          <State option="state" :data="record"></State>
        </template>

        <template slot="customOperation">
          Operation
          <a-button
            v-permit="'app:create'"
            type="primary"
            shape="circle"
            icon="plus"
            style="margin-left: 20px; width: 25px;height: 25px;min-width: 25px"
            @click="handleAdd">
          </a-button>
        </template>

        <template slot="operation" slot-scope="text, record">
          <a-icon
            v-if="record.state !== 5
              && optionApps.deploy.get(record.id) === undefined
              && optionApps.stoping.get(record.id) === undefined
              && optionApps.starting.get(record.id) === undefined
              && record.optionState === 0"
            v-permit="'app:mapping'"
            type="deployment-unit"
            style="color:#4a9ff5"
            @click="handleMapping(record)">
          </a-icon>
          <icon-font
            type="icon-deploy"
            v-show="record.deploy === 1 && record.state !== 1 && (optionApps.deploy.get(record.id) === undefined || record.optionState === 0)"
            v-permit="'app:deploy'"
            @click="handleDeploy(record)">
          </icon-font>
          <a-icon
            v-permit="'app:update'"
            type="setting"
            theme="twoTone"
            twoToneColor="#4a9ff5"
            @click="handleEdit(record)"
            title="修改角色">
          </a-icon>
          <a-icon
            type="play-circle"
            v-show="(record.state === 0
              || record.state === 2
              || record.state === 7
              || record.state === 9
              || record.state === 10
              || record.state === 11
              || record.state === 13)
              && (optionApps.starting.get(record.id) === undefined || record.optionState === 0)"
            v-permit="'app:start'"
            theme="twoTone"
            twoToneColor="#4a9ff5"
            @click="handleStart(record)">
          </a-icon>
          <a-icon
            type="poweroff"
            title="停止应用"
            v-permit="'app:cancel'"
            style="color:#4a9ff5"
            v-show="record.state === 5"
            @click="handleCancel(record)">
          </a-icon>
          <a-icon
            type="eye"
            v-permit="'app:detail'"
            theme="twoTone"
            twoToneColor="#4a9ff5"
            @click="handleDetail(record)"
            title="查看">
          </a-icon>
        </template>

      </a-table>

      <a-modal v-model="deployVisible" on-ok="handleDeployOk">
        <template slot="title">
          <a-icon slot="icon" type="upload" style="color: green"/>
          Deploy Application
        </template>
        <template slot="footer">
          <a-button key="back" @click="handleDeployCancel">
            取消
          </a-button>
          <a-button key="submit" type="primary" :loading="loading" @click="handleDeployOk">
            确定
          </a-button>
        </template>
        <a-form @submit="handleDeployOk" :form="formDeploy">
          <a-form-item
            v-if="application && application.state === 5 "
            label="restart"
            :labelCol="{lg: {span: 7}, sm: {span: 7}}"
            :wrapperCol="{lg: {span: 16}, sm: {span: 4} }">
            <a-switch
              checkedChildren="开"
              unCheckedChildren="关"
              checked-children="true"
              un-checked-children="false"
              placeholder="重启应用"
              v-model="restart"
              v-decorator="['restart']"/>
            <span class="conf-switch" style="color:darkgrey"> restart application after deploy</span>
          </a-form-item>
          <a-form-item
            v-if="restart"
            label="Savepoint"
            :labelCol="{lg: {span: 7}, sm: {span: 7}}"
            :wrapperCol="{lg: {span: 16}, sm: {span: 4} }">
            <a-switch
              checkedChildren="开"
              unCheckedChildren="关"
              checked-children="true"
              un-checked-children="false"
              v-model="savePoint"
              v-decorator="['savePoint']"/>
            <span class="conf-switch" style="color:darkgrey"> trigger savePoint before taking stoping </span>
          </a-form-item>
          <a-form-item
            v-if="restart"
            label="ignore restored"
            :labelCol="{lg: {span: 7}, sm: {span: 7}}"
            :wrapperCol="{lg: {span: 16}, sm: {span: 4} }">
            <a-switch
              checkedChildren="开"
              unCheckedChildren="关"
              checked-children="true"
              un-checked-children="false"
              v-model="allowNonRestoredState"
              v-decorator="['allowNonRestoredState']"/>
            <span class="conf-switch" style="color:darkgrey"> ignore savepoint then cannot be restored </span>
          </a-form-item>
          <a-form-item
            label="backup desc"
            :labelCol="{lg: {span: 7}, sm: {span: 7}}"
            :wrapperCol="{lg: {span: 16}, sm: {span: 4} }">
            <a-textarea
              rows="3"
              placeholder="应用重新发布前会先备份当前的应用,请输入当前应用的备份描述信息,以便回滚版本时找回"
              v-decorator="['description',{ rules: [{ required: true, message: '请输入备份描述' } ]}]">
            </a-textarea>
          </a-form-item>
        </a-form>
      </a-modal>

      <a-modal v-model="startVisible" on-ok="handleStartOk">
        <template slot="title">
          <a-icon slot="icon" type="play-circle" style="color: green"/>
          Start application
        </template>

        <a-form @submit="handleStartOk" :form="formStartCheckPoint">
          <a-form-item
            label="from savepoint"
            :labelCol="{lg: {span: 7}, sm: {span: 7}}"
            :wrapperCol="{lg: {span: 16}, sm: {span: 4} }">
            <a-switch
              checkedChildren="开"
              unCheckedChildren="关"
              checked-children="true"
              un-checked-children="false"
              v-model="savePoint"
              v-decorator="['savePoint']"/>
            <span class="conf-switch" style="color:darkgrey"> restore the job from savepoint</span>
          </a-form-item>

          <a-form-item
            v-if="savePoint"
            label="ignore restored"
            :labelCol="{lg: {span: 7}, sm: {span: 7}}"
            :wrapperCol="{lg: {span: 16}, sm: {span: 4} }">
            <a-switch
              checkedChildren="开"
              unCheckedChildren="关"
              checked-children="true"
              un-checked-children="false"
              v-model="allowNonRestoredState"
              v-decorator="['allowNonRestoredState']"/>
            <span class="conf-switch" style="color:darkgrey"> ignore savepoint then cannot be restored </span>
          </a-form-item>

          <a-form-item
            v-if="savePoint && !lastestSavePoint "
            label="savepoint"
            style="margin-bottom: 10px"
            :labelCol="{lg: {span: 7}, sm: {span: 7}}"
            :wrapperCol="{lg: {span: 16}, sm: {span: 4} }">
            <a-select
              mode="combobox"
              allowClear
              v-decorator="['savepoint',{ rules: [{ required: true } ]}]">
              <a-select-option
                v-for="(k ,i) in historySavePoint"
                :key="i"
                :value="k.savePoint">
                <template>
                  <span style="color:#108ee9">
                    {{ k.savePoint.substr(k.savePoint.lastIndexOf('-') + 1) }}
                  </span>
                  <span style="float: right; color: darkgrey">
                    <a-icon type="clock-circle"/> {{ k.createTime }}
                  </span>
                </template>
              </a-select-option>
            </a-select>
            <span class="conf-switch" style="color:darkgrey"> restore the job from savepoint</span>
          </a-form-item>
        </a-form>

        <template slot="footer">
          <a-button key="back" @click="handleStartCancel">
            取消
          </a-button>
          <a-button key="submit" type="primary" :loading="loading" @click="handleStartOk">
            确定
          </a-button>
        </template>
      </a-modal>
      <a-modal v-model="stopVisible" on-ok="handleStopOk">
        <template slot="title">
          <a-icon slot="icon" type="poweroff" style="color: red"/>
          Stop application
        </template>

        <a-form @submit="handleStopOk" :form="formStopSavePoint">
          <a-form-item
            label="Savepoint"
            :labelCol="{lg: {span: 5}, sm: {span: 5}}"
            :wrapperCol="{lg: {span: 17}, sm: {span: 5} }">
            <a-switch
              checkedChildren="开"
              unCheckedChildren="关"
              checked-children="true"
              un-checked-children="false"
              v-model="savePoint"
              v-decorator="['savePoint']"/>
            <span class="conf-switch" style="color:darkgrey"> trigger savePoint before taking stoping </span>
          </a-form-item>
          <a-form-item
            label="Drain"
            :labelCol="{lg: {span: 5}, sm: {span: 5}}"
            :wrapperCol="{lg: {span: 17}, sm: {span: 5} }">
            <a-switch
              checkedChildren="开"
              unCheckedChildren="关"
              checked-children="true"
              un-checked-children="false"
              placeholder="Send max watermark before taking stoping"
              v-model="drain"
              v-decorator="['drain']"/>
            <span class="conf-switch" style="color:darkgrey"> Send max watermark before stoping</span>
          </a-form-item>
        </a-form>

        <template slot="footer">
          <a-button key="back" @click="handleStopCancel">
            取消
          </a-button>
          <a-button key="submit" type="primary" :loading="loading" @click="handleStopOk">
            确定
          </a-button>
        </template>
      </a-modal>

      <a-modal v-model="mappingVisible" on-ok="handleMappingOk">
        <template slot="title">
          <a-icon slot="icon" type="deployment-unit" style="color: green"/>
          Mapping application
        </template>

        <a-form @submit="handleMappingOk" :form="formMapping">
          <a-form-item
            v-if="mappingVisible"
            label="Application Name"
            :labelCol="{lg: {span: 7}, sm: {span: 7}}"
            :wrapperCol="{lg: {span: 16}, sm: {span: 4} }">
            <a-alert :message="application.jobName" type="info"/>
          </a-form-item>
          <a-form-item
            label="Application Id"
            :labelCol="{lg: {span: 7}, sm: {span: 7}}"
            :wrapperCol="{lg: {span: 16}, sm: {span: 4} }">
            <a-input
              type="text"
              placeholder="请输入 ApplicationId"
              v-decorator="[ 'appId', {rules: [{ required: true, message: '请输入ApplicationId'}]} ]"/>
          </a-form-item>
          <a-form-item
            label="JobId"
            :labelCol="{lg: {span: 7}, sm: {span: 7}}"
            :wrapperCol="{lg: {span: 16}, sm: {span: 4} }">
            <a-input
              type="text"
              placeholder="请输入 JobId"
              v-decorator="[ 'jobId', {rules: [{ required: true, message: '请输入 JobId'}]} ]"/>
          </a-form-item>
        </a-form>

        <template slot="footer">
          <a-button key="back" @click="handleMappingCancel">
            取消
          </a-button>
          <a-button key="submit" type="primary" :loading="loading" @click="handleMappingOk">
            确定
          </a-button>
        </template>
      </a-modal>

    </a-card>
  </div>
</template>
<script>
import Ellipsis from '@/components/Ellipsis'
import RangeDate from '@comp/DateTime/RangeDate'
import State from './State'

import { mapActions } from 'vuex'
import { list, dashboard, cancel, deploy, mapping, start, clean, yarn } from '@api/application'
import { lastest, history } from '@api/savepoint'
import { Icon } from 'ant-design-vue'

const IconFont = Icon.createFromIconfontCN({
  scriptUrl: '//at.alicdn.com/t/font_2006309_wqixwmes1xi.js'
})
export default {
  components: { RangeDate, Ellipsis, State, IconFont },
  data () {
    return {
      loading: false,
      dashLoading: true,
      dataSource: [],
      metrics: {
        availableSlot: 0,
        totalSlot: 0,
        totalTM: 0,
        jmMemory: 0,
        tmMemory: 0,
        task: {
          total: 0,
          running: 0
        }
      },
      expandedRow: ['appId', 'jmMemory', 'tmMemory', 'totalTM', 'totalSlot', 'availableSlot', 'flinkCommit'],
      queryParams: {},
      sortedInfo: null,
      filteredInfo: null,
      queryInterval: 2000,
      yarn: null,
      deployVisible: false,
      stopVisible: false,
      startVisible: false,
      mappingVisible: false,
      formDeploy: null,
      formStopSavePoint: null,
      formStartCheckPoint: null,
      formMapping: null,
      drain: false,
      savePoint: true,
      restart: false,
      application: null,
      lastestSavePoint: null,
      historySavePoint: null,
      allowNonRestoredState: false,
      searchText: '',
      searchInput: null,
      optionApps: {
        'starting': new Map(),
        'stoping': new Map(),
        'deploy': new Map()
      },
      searchedColumn: '',
      paginationInfo: null,
      pagination: {
        pageSizeOptions: ['10', '20', '30', '40', '100'],
        defaultCurrent: 1,
        defaultPageSize: 10,
        showQuickJumper: true,
        showSizeChanger: true,
        showTotal: (total, range) => `显示 ${range[0]} ~ ${range[1]} 条记录，共 ${total} 条记录`
      }
    }
  },

  computed: {
    colorsMap () {
      const map = new Map()
      map.set('TOTAL', '#102541')
      map.set('CREATED', '#2f54eb')
      map.set('SCHEDULED', '#722ed1')
      map.set('DEPLOYING', '#13c2c2')
      map.set('RUNNING', '#52c41a')
      map.set('FINISHED', '#1890ff')
      map.set('CANCELING', '#faad14')
      map.set('CANCELED', '#fa8c16')
      map.set('FAILED', '#f5222d')
      map.set('RECONCILING', '#eb2f96')
      return map
    },
    innerColumns () {
      return [
        { title: 'Application Id', dataIndex: 'appId', key: 'appId', width: 280 },
        { title: 'JobManager Memory', dataIndex: 'jmMemory', key: 'jmMemory' },
        { title: 'TaskManager Memory', dataIndex: 'tmMemory', key: 'tmMemory' },
        { title: 'Total TaskManager', dataIndex: 'totalTM', key: 'totalTM' },
        { title: 'Total Slots', dataIndex: 'totalSlot', key: 'totalSlot' },
        { title: 'Available Slots', dataIndex: 'availableSlot', key: 'availableSlot' }
      ]
    },
    columns () {
      let { sortedInfo, filteredInfo } = this
      sortedInfo = sortedInfo || {}
      filteredInfo = filteredInfo || {}
      return [{
        title: 'Job Name',
        dataIndex: 'jobName',
        width: 250,
        scopedSlots: {
          filterDropdown: 'filterDropdown',
          filterIcon: 'filterIcon',
          customRender: 'filterRender'
        },
        onFilter: (value, record) =>
          record.jobName
            .toString()
            .toLowerCase()
            .includes(value.toLowerCase()),
        onFilterDropdownVisibleChange: visible => {
          if (visible) {
            setTimeout(() => {
              this.searchInput.focus()
            })
          }
        }
      }, {
        title: 'Project',
        dataIndex: 'projectName',
        width: 200,
        scopedSlots: {
          filterDropdown: 'filterDropdown',
          filterIcon: 'filterIcon',
          customRender: 'filterRender'
        },
        onFilter: (value, record) =>
          record['projectName']
            .toString()
            .toLowerCase()
            .includes(value.toLowerCase()),
        onFilterDropdownVisibleChange: visible => {
          if (visible) {
            setTimeout(() => {
              this.searchInput.focus()
            })
          }
        }
      }, {
        title: 'Start Time',
        dataIndex: 'startTime',
        sorter: true,
        sortOrder: sortedInfo.columnKey === 'startTime' && sortedInfo.order,
        width: 180
      }, {
        title: 'Duration',
        dataIndex: 'duration',
        sorter: true,
        sortOrder: sortedInfo.columnKey === 'duration' && sortedInfo.order,
        scopedSlots: { customRender: 'duration' },
        width: 150
      }, {
        title: 'Task',
        dataIndex: 'task',
        scopedSlots: { customRender: 'task' },
        width: 100
      }, {
        title: 'Status',
        dataIndex: 'state',
        width: 120,
        scopedSlots: { customRender: 'state' },
        filters: [
          { text: 'CREATED', value: 0 },
          { text: 'DEPLOYING', value: 1 },
          { text: 'DEPLOYED', value: 2 },
          { text: 'STARTING', value: 3 },
          { text: 'RESTARTING', value: 4 },
          { text: 'RUNNING', value: 5 },
          { text: 'FAILING', value: 6 },
          { text: 'FAILED', value: 7 },
          { text: 'CANCELED', value: 9 },
          { text: 'FINISHED', value: 10 },
          { text: 'LOST', value: 13 }
        ],
        filteredValue: filteredInfo.state || null,
        onFilter: (value, record) => {
          return record.state === value
        },
        sorter: (a, b) => a.state - b.state,
        sortOrder: sortedInfo.columnKey === 'state' && sortedInfo.order
      }, {
        dataIndex: 'operation',
        key: 'operation',
        scopedSlots: { customRender: 'operation' },
        slots: { title: 'customOperation' },
        width: 150
      }]
    }
  },

  mounted () {
    this.handleYarn()
    this.handleFetch(true)
    const timer = window.setInterval(() => {
      this.handleDashboard()
      this.handleFetch(false)
    }, this.queryInterval)
    this.$once('hook:beforeDestroy', () => {
      clearInterval(timer)
    })
  },

  beforeMount () {
    this.formDeploy = this.$form.createForm(this)
    this.formStopSavePoint = this.$form.createForm(this)
    this.formStartCheckPoint = this.$form.createForm(this)
    this.formMapping = this.$form.createForm(this)
  },

  methods: {
    ...mapActions(['SetAppId']),

    handleDeploy (app) {
      if (this.optionApps.deploy.get(app.id) === undefined || app.optionState === 0) {
        this.deployVisible = true
        this.application = app
      }
    },

    handleDeployCancel () {
      this.deployVisible = false
      setTimeout(() => {
        this.application = null
        this.restart = false
        this.allowNonRestoredState = false
        this.savePoint = true
        this.formDeploy.resetFields()
      }, 1000)
    },

    handleDeployOk () {
      this.formDeploy.validateFields((err, values) => {
        if (!err) {
          const id = this.application.id
          const savePoint = this.savePoint
          const description = values.description
          const restart = this.restart
          const allowNonRestoredState = this.allowNonRestoredState
          this.handleDeployCancel()
          this.$message.info(
            '已发送部署请求,后台正在执行部署,请耐心等待',
            3
          )
          this.optionApps.deploy.set(id, new Date().getTime())
          this.handleMapUpdate('deploy')
          deploy({
            id: id,
            restart: restart,
            savePointed: savePoint,
            allowNonRestored: allowNonRestoredState,
            backUpDescription: description
          }).then((resp) => {
            if (!restart) {
              this.optionApps.deploy.delete(id)
              this.handleMapUpdate('deploy')
            }
          })
        }
      })
    },

    handleMapping (app) {
      this.mappingVisible = true
      this.application = app
    },

    handleMappingOk () {
      this.formMapping.validateFields((err, values) => {
        if (!err) {
          this.$message.info(
            '已发送手动映射请求,请稍后',
            3
          )
          const appId = values.appId
          const jobId = values.jobId
          const id = this.application.id
          this.handleMappingCancel()
          mapping({
            id: id,
            appId: appId,
            jobId: jobId
          }).then((resp) => {
            console.log(resp)
          })
        }
      })
    },

    handleMappingCancel () {
      this.mappingVisible = false
      setTimeout(() => {
        this.application = null
        this.formMapping.resetFields()
      }, 1000)
    },

    handleStart (app) {
      if (this.optionApps.starting.get(app.id) === undefined || app.optionState === 0) {
        this.application = app
        lastest({
          appId: this.application.id
        }).then((resp) => {
          this.lastestSavePoint = resp.data || null
          this.startVisible = true
          if (!this.lastestSavePoint) {
            history({
              appId: this.application.id,
              pageNum: 1,
              pageSize: 9999
            }).then((resp) => {
              this.historySavePoint = resp.data.records || []
            })
          }
        })
      }
    },

    handleStartCancel () {
      this.startVisible = false
      setTimeout(() => {
        this.allowNonRestoredState = false
        this.formStartCheckPoint.resetFields()
        this.application = null
        this.savePoint = true
      }, 1000)
    },

    handleStartOk () {
      this.formStartCheckPoint.validateFields((err, values) => {
        if (!err) {
          this.$message.info(
            '已发送启动请求,该应用正在启动中',
            3
          )
          const id = this.application.id
          const savePointed = this.savePoint
          const savePoint = savePointed ? (values['savepoint'] || this.lastestSavePoint.savePoint) : null
          const allowNonRestoredState = this.allowNonRestoredState
          console.log('update starting before:' + this.optionApps.starting.size)
          this.optionApps.starting.set(id, new Date().getTime())
          this.handleMapUpdate('starting')
          this.handleStartCancel()
          start({
            id: id,
            savePointed: savePointed,
            savePoint: savePoint,
            allowNonRestored: allowNonRestoredState
          }).then((resp) => {
            if (!resp.data) {
              this.$message.error(
                '应用启动失败,请查看启动日志',
                3
              )
            }
          })
        }
      })
    },

    handleCancel (app) {
      if (this.optionApps.stoping.get(app.id) === undefined || app.optionState === 0) {
        this.stopVisible = true
        this.application = app
      }
    },

    handleStopCancel () {
      this.stopVisible = false
      setTimeout(() => {
        this.formStopSavePoint.resetFields()
        this.drain = false
        this.savePoint = true
        this.application = null
      }, 1000)
    },

    handleStopOk () {
      this.$message.info(
        '已发送停止请求,该应用正在停止',
        3
      )
      const savePoint = this.savePoint
      const drain = this.drain
      const id = this.application.id
      console.log('update stoping before:' + this.optionApps.stoping.size)
      this.optionApps.stoping.set(id, new Date().getTime())
      this.handleMapUpdate('stoping')
      this.handleStopCancel()
      cancel({
        id: id,
        savePointed: savePoint,
        drain: drain
      }).then((resp) => {
        if (resp.status === 'error') {
          this.$notification.open({
            message: 'cancel application failed',
            description: resp.exception,
            icon: <a-icon type="error" style="color: #f5222d"/>
          })
        }
      })
    },

    handleDetail (app) {
      this.SetAppId(app.id)
      this.$router.push({ 'path': '/flink/app/detail' })
    },

    handleSearch (selectedKeys, confirm, dataIndex) {
      confirm()
      this.searchText = selectedKeys[0]
      this.searchedColumn = dataIndex
      this.queryParams[this.searchedColumn] = this.searchText
      const { sortedInfo } = this
      // 获取当前列的排序和列的过滤规则
      if (sortedInfo) {
        this.queryParams['sortField'] = sortedInfo.field
        this.queryParams['sortOrder'] = sortedInfo.order
      }
    },

    handleReset (clearFilters) {
      clearFilters()
      this.searchText = ''
      // 重置列排序规则
      this.sortedInfo = null
      // 重置查询参数
      this.queryParams = {}
    },

    handleTableChange (pagination, filters, sorter) {
      this.sortedInfo = sorter
      this.paginationInfo = pagination
      this.queryParams['sortField'] = sorter.field
      this.queryParams['sortOrder'] = sorter.order
      this.handleFetch(true)
    },

    handleFetch (loading) {
      if (loading) this.loading = true
      const params = Object.assign(this.queryParams, {})
      if (this.paginationInfo) {
        // 如果分页信息不为空，则设置表格当前第几页，每页条数，并设置查询分页参数
        this.$refs.TableInfo.pagination.current = this.paginationInfo.current
        this.$refs.TableInfo.pagination.pageSize = this.paginationInfo.pageSize
        params.pageSize = this.paginationInfo.pageSize
        params.pageNum = this.paginationInfo.current
      } else {
        // 如果分页信息为空，则设置为默认值
        params.pageSize = this.pagination.defaultPageSize
        params.pageNum = this.pagination.defaultCurrent
      }
      list({ ...params }).then((resp) => {
        this.loading = false
        const pagination = { ...this.pagination }
        pagination.total = parseInt(resp.data.total)
        const dataSource = resp.data.records
        const timestamp = new Date().getTime()
        dataSource.forEach(x => {
          x.expanded = [{
            'appId': x.appId,
            'jmMemory': x.jmMemory,
            'tmMemory': x.tmMemory,
            'totalTM': x.totalTM,
            'totalSlot': x.totalSlot,
            'availableSlot': x.availableSlot
          }]
          if (x.optionState === 0) {
            if (this.optionApps.starting.get(x.id) !== undefined) {
              if (timestamp - this.optionApps.starting.get(x.id) > this.queryInterval * 2) {
                this.optionApps.starting.delete(x.id)
                this.handleMapUpdate('starting')
              }
            }
            if (this.optionApps.stoping.get(x.id) !== undefined) {
              if (timestamp - this.optionApps.stoping.get(x.id) > this.queryInterval) {
                this.optionApps.stoping.delete(x.id)
                this.handleMapUpdate('stoping')
              }
            }
            if (this.optionApps.deploy.get(x.id) !== undefined) {
              if (timestamp - this.optionApps.deploy.get(x.id) > this.queryInterval) {
                this.optionApps.deploy.delete(x.id)
                this.handleMapUpdate('deploy')
              }
            }
          }
        })
        this.dataSource = dataSource
        this.pagination = pagination
      })
    },

    handleDashboard () {
      dashboard({}).then((resp) => {
        const status = resp.status || 'error'
        if (status === 'success') {
          this.dashLoading = false
          this.metrics = resp.data || {}
        }
      })
    },

    handleExpandIcon (props) {
      if (props.record.state === 5) {
        if (props.expanded) {
          return <a class='expand-icon-open' onClick={(e) => {
            props.onExpand(props.record, e)
          }}>
            <a-icon type='down'/>
          </a>
        } else {
          return <a class='expand-icon-close' onClick={(e) => {
            props.onExpand(props.record, e)
          }}>
            <a-icon type='right'/>
          </a>
        }
      } else {
        return ''
      }
    },

    handleYarn (params = {}) {
      yarn({}).then((resp) => {
        this.yarn = resp.data
      })
    },

    handleView (params) {
      if (params.state === 4 || params.state === 5 || params.optionState === 4) {
        const url = this.yarn + '/proxy/' + params['appId'] + '/'
        window.open(url)
      }
    },

    handleAdd () {
      this.$router.push({ 'path': '/flink/app/add' })
    },

    handleEdit (app) {
      this.SetAppId(app.id)
      if (app.appType === 1) {
        this.$router.push({ 'path': '/flink/app/edit_streamx' })
      } else {
        this.$router.push({ 'path': '/flink/app/edit_flink' })
      }
    },

    handleCleanDeploy (app) {
      clean({
        id: app.id
      }).then((resp) => {
      })
    },

    handleMapUpdate (type) {
      const map = this.optionApps[type]
      this.optionApps[type] = new Map(map)
    }
  }
}
</script>

<style scoped>

.ant-upload.ant-upload-drag p.ant-upload-drag-icon .anticon {
  font-size: 100px;
}

.ant-alert.ant-alert-no-icon {
  padding: 6px 15px;
}

.ant-modal-header {
  border-bottom: unset;
}

.ant-modal-footer {
  border-top: unset;
}

.ant-modal-body {
  padding-bottom: 5px;
  padding-top: 5px;
}

.ant-input-number {
  width: 100%;
}

.close-deploy {
  left: 15px;
  font-size: 8px;
  font-weight: bold;
  top: -8px;
}

.app_list >>> .ant-table-thead > tr > td, .app_list >>> .ant-table-tbody > tr > td {
  padding: 9px 9px !important;
}

.app_list >>> .ant-table-thead > tr > th {
  background: unset !important;
}

.gutter-box {
  padding: 10px 15px;
  background: #fff;
  color: rgba(0, 0, 0, 0.65);
  font-size: 14px;
  font-variant: tabular-nums;
  line-height: 1.5;
  list-style: none;
  -webkit-font-feature-settings: 'tnum';
  font-feature-settings: 'tnum';
  position: relative;
  border-radius: 2px;
  transition: all 0.3s;
}

.gutter-box >>> .ant-divider-horizontal {
  margin: 15px 0;
}

.dash-statistic >>> .ant-card-body {
  padding: 5px !important;
}

.operation {
  width: 80px;
}

>>> .ant-badge-dot, .ant-badge {
  right: unset !important;
}

.pointer {
  cursor: pointer;
}

.expanded-table >>> .ant-table-tbody > tr > td {
  border-bottom: none !important;
  padding: 11px 9px !important;
}

.expanded-table >>> .ant-table-tbody > tr {
  border-bottom: none !important;
  padding: 11px 9px !important;
}

.expand-icon-open {
  font-size: 10px;
}

.expand-icon-close {
  font-size: 10px;
  color: darkgray;
}

.task-tag > .ant-tag {
  border-radius: 0;
  font-weight: 700;
  font-size: 13px;
  text-align: center;
  padding: 0 4px;
  margin-right: 0px;
  cursor: default;
}
</style>
